<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | LeePola</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>

    <style>
        /* --- 1. CSS VARIABLES (Matches Main Site) --- */
        :root {
            --primary: #2D1B15; 
            --wood: #5D4037; 
            --accent: #C5A059; 
            --bg: #F4F4F4; 
            --white: #FFFFFF; 
            --red: #D32F2F; 
            --green: #2E7D32; 
            --blue: #1976D2;
            --shadow: 0 10px 30px rgba(45, 27, 21, 0.08);
            --glass: rgba(255, 255, 255, 0.95);
            --radius: 12px;
        }

        * { box-sizing: border-box; font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); display: flex; min-height: 100vh; overflow-x: hidden; color: var(--primary); }
        
        /* --- SIDEBAR --- */
        .sidebar { 
            width: 280px; background: var(--primary); color: white; padding: 30px; 
            position: fixed; height: 100%; display: flex; flex-direction: column; 
            box-shadow: 5px 0 20px rgba(0,0,0,0.1); z-index: 100;
        }
        .brand { 
            font-family: 'Playfair Display', serif; font-size: 2rem; margin-bottom: 50px; 
            display: block; color: white; text-decoration: none; font-weight: 700; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .brand span { color: var(--accent); }
        
        .menu-label { font-size: 0.75rem; text-transform: uppercase; color: #888; margin-bottom: 10px; letter-spacing: 1px; font-weight: 700; }
        
        .menu-item { 
            padding: 15px 20px; cursor: pointer; color: #ccc; transition: 0.3s; 
            display: flex; align-items: center; gap: 12px; margin-bottom: 8px; 
            border-radius: 10px; font-weight: 500; text-decoration: none; 
        }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: var(--accent); transform: translateX(5px); }
        .menu-item.active { background: var(--accent); color: var(--primary); font-weight: 700; box-shadow: 0 5px 15px rgba(197, 160, 89, 0.3); }
        
        .menu-item.danger { color: #ef9a9a; margin-top: auto; border: 1px solid rgba(211, 47, 47, 0.3); }
        .menu-item.danger:hover { background: var(--red); color: white; border-color: var(--red); }

        /* --- MAIN CONTENT --- */
        .main-content { margin-left: 280px; padding: 50px; width: calc(100% - 280px); transition: 0.3s; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; animation: slideDown 0.6s ease; }
        h2 { font-family: 'Playfair Display', serif; color: var(--primary); font-size: 2.2rem; margin: 0; }
        .breadcrumb { color: #888; font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & FORMS --- */
        .card { 
            background: var(--white); padding: 40px; border-radius: 20px; 
            box-shadow: var(--shadow); margin-bottom: 40px; border: 1px solid white;
            animation: fadeIn 0.8s ease; 
        }
        .card-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; 
        }
        .card-title { font-size: 1.4rem; font-weight: 700; color: var(--primary); font-family: 'Playfair Display', serif; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 25px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; position: relative; }
        
        label { font-size: 0.75rem; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, select, textarea { 
            padding: 14px; border: 2px solid #eee; border-radius: 10px; 
            outline: none; transition: 0.3s; background: #fafafa; font-size: 0.95rem; 
            color: var(--primary); width: 100%; font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--accent); background: white; 
            box-shadow: 0 5px 15px rgba(197, 160, 89, 0.1); 
        }
        
        /* IMAGE UPLOAD UI */
        .img-tabs { display: flex; gap: 5px; margin-bottom: 10px; background: #f0f0f0; padding: 5px; border-radius: 10px; width: fit-content; }
        .img-tab { 
            padding: 8px 20px; font-size: 0.8rem; cursor: pointer; border-radius: 8px; 
            font-weight: 600; color: #666; transition: 0.3s; 
        }
        .img-tab.active { background: var(--white); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .file-preview { 
            width: 120px; height: 120px; object-fit: cover; margin-top: 15px; 
            border-radius: 12px; border: 2px dashed var(--accent); display: none; 
            background: #fff; padding: 5px; 
        }

        /* SUGGESTION CHIPS */
        .suggestion-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .chip { 
            padding: 6px 14px; background: #f4f4f4; border-radius: 20px; 
            font-size: 0.75rem; cursor: pointer; border: 1px solid #eee; 
            transition: 0.2s; color: #666; font-weight: 600;
        }
        .chip:hover { background: var(--primary); color: var(--accent); border-color: var(--primary); transform: translateY(-2px); }
        .chip:active { transform: scale(0.95); }

        /* BUTTONS */
        .btn { 
            padding: 14px 30px; border: none; border-radius: 50px; cursor: pointer; 
            font-weight: 700; text-transform: uppercase; font-size: 0.85rem; 
            letter-spacing: 1px; transition: 0.3s; display: inline-flex; align-items: center; gap: 10px;
        }
        .btn-primary { background: var(--primary); color: var(--accent); box-shadow: 0 5px 15px rgba(45, 27, 21, 0.2); }
        .btn-primary:hover { background: var(--accent); color: var(--primary); transform: translateY(-3px); }
        
        .btn-secondary { background: #eee; color: #555; }
        .btn-secondary:hover { background: #ddd; }
        
        .btn-update { background: linear-gradient(135deg, #1E88E5, #1565C0); color: white; }
        .btn-update:hover { box-shadow: 0 5px 15px rgba(21, 101, 192, 0.3); transform: translateY(-3px); }

        /* TABLES */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 10px; margin-top: 0; }
        th { text-align: left; padding: 15px 20px; color: #888; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        td { background: white; padding: 20px; vertical-align: middle; border-top: 1px solid #f9f9f9; border-bottom: 1px solid #f9f9f9; font-size: 0.9rem; }
        tr td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; border-left: 1px solid #f9f9f9; }
        tr td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-right: 1px solid #f9f9f9; }
        tr:hover td { background: #fcfcfc; transform: scale(1.005); transition: 0.2s; }
        
        .table-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .action-group { display: flex; gap: 8px; }
        .action-btn { 
            cursor: pointer; font-weight: 600; border: none; font-size: 0.8rem; 
            padding: 8px 16px; border-radius: 6px; transition: 0.2s; 
        }
        .btn-manage { color: var(--green); background: rgba(46, 125, 50, 0.1); }
        .btn-manage:hover { background: var(--green); color: white; }
        .btn-edit { color: var(--blue); background: rgba(25, 118, 210, 0.1); }
        .btn-edit:hover { background: var(--blue); color: white; }
        .btn-delete { color: var(--red); background: rgba(211, 47, 47, 0.1); }
        .btn-delete:hover { background: var(--red); color: white; }
        
        /* VIEWS */
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* SHOP BANNER */
        .shop-banner { 
            background: linear-gradient(135deg, var(--primary), #3E2723); 
            color: var(--accent); padding: 40px; border-radius: 20px; 
            margin-bottom: 40px; display: flex; align-items: center; justify-content: space-between; 
            box-shadow: 0 15px 30px rgba(45, 27, 21, 0.25); position: relative; overflow: hidden;
        }
        .shop-banner::before {
            content: ''; position: absolute; top: -50%; right: -10%; width: 300px; height: 300px;
            background: rgba(255,255,255,0.05); border-radius: 50%;
        }
        .banner-info h1 { margin: 0; font-size: 2.5rem; }
        .banner-info p { color: rgba(255,255,255,0.6); margin-top: 5px; font-size: 1.1rem; }
    </style>
</head>
<body>

    <div class="sidebar">
        <a href="index.html" class="brand">Lee<span>Pola</span> Admin</a>
        
        <div class="menu-label">Main Menu</div>
        <div id="menu-shops" class="menu-item active" onclick="app.showShopList()">
            <i class="fa-solid fa-store"></i> Manage Shops
        </div>
        
        <div id="menu-current" class="menu-item" style="display:none;" onclick="app.showShopDashboard()">
            <i class="fa-solid fa-folder-open"></i> <span id="nav-shop-name">Current Shop</span>
        </div>

        <div class="menu-label" style="margin-top: 30px;">System</div>
        <a href="index.html" class="menu-item">
            <i class="fa-solid fa-arrow-left"></i> Back to Website
        </a>
        
        <div class="menu-item danger" onclick="app.resetData()">
            <i class="fa-solid fa-triangle-exclamation"></i> Reset Data
        </div>
    </div>

    <div class="main-content">

        <div id="view-shops" class="view-section active">
            <header>
                <div>
                    <div class="breadcrumb">Dashboard / Shops</div>
                    <h2>All Shops</h2>
                </div>
            </header>

            <div class="card">
                <div class="card-header"><span class="card-title"><i class="fa-solid fa-circle-plus" style="color:var(--green)"></i> Add New Shop</span></div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Shop Name</label>
                        <input id="s-name" type="text" placeholder="e.g. Colombo Woodworks">
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input id="s-loc" type="text" placeholder="e.g. Nugegoda">
                    </div>
                    <div class="form-group">
                        <label>WhatsApp Number</label>
                        <input id="s-tel" type="text" placeholder="94771234567">
                    </div>
                    
                    <div class="form-group">
                        <label>Shop Logo</label>
                        <div class="img-tabs">
                            <span class="img-tab active" onclick="app.switchImgInput('s-logo', 'url')"><i class="fa-solid fa-link"></i> URL</span>
                            <span class="img-tab" onclick="app.switchImgInput('s-logo', 'file')"><i class="fa-solid fa-upload"></i> Upload</span>
                        </div>
                        <input id="s-logo-url" type="text" placeholder="https://example.com/logo.jpg" oninput="app.updateUrlPreview('s-logo')">
                        <input id="s-logo-file" type="file" accept="image/*" style="display:none;" onchange="app.previewImage(this, 's-logo-preview')">
                        <img id="s-logo-preview" class="file-preview">
                        <input type="hidden" id="s-logo-final"> 
                    </div>
                </div>
                <button class="btn btn-primary" onclick="app.addShop()">Create Shop</button>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">Registered Shops</span></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Logo</th><th>Shop Name</th><th>Location</th><th>Contact</th><th>Actions</th></tr></thead>
                        <tbody id="shop-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-single" class="view-section">
            
            <div class="shop-banner">
                <div class="banner-info">
                    <h1 id="dash-shop-name">Shop Name</h1>
                    <p id="dash-shop-loc"><i class="fa-solid fa-location-dot"></i> Location</p>
                </div>
                <button class="btn btn-secondary" onclick="app.showShopList()">Switch Shop</button>
            </div>

            <div class="card" id="product-form-card" style="border-top: 4px solid var(--accent);">
                <div class="card-header">
                    <span class="card-title" id="form-title">Add Product</span>
                    <button class="btn btn-secondary" id="cancel-edit-btn" style="display:none; font-size:0.7rem;" onclick="app.cancelEdit()">Cancel</button>
                </div>
                
                <div class="form-grid">
                    <div class="form-group"><label>Product Name</label><input id="p-name" type="text"></div>
                    <div class="form-group"><label>Price (LKR)</label><input id="p-price" type="number"></div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="p-cat">
                            <option value="Table">Table</option>
                            <option value="Chair">Chair</option>
                            <option value="Bed">Bed</option>
                            <option value="Storage">Storage</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Product Image</label>
                        <div class="img-tabs">
                            <span class="img-tab active" onclick="app.switchImgInput('p-img', 'url')"><i class="fa-solid fa-link"></i> URL</span>
                            <span class="img-tab" onclick="app.switchImgInput('p-img', 'file')"><i class="fa-solid fa-upload"></i> Upload</span>
                        </div>
                        <input id="p-img-url" type="text" placeholder="https://..." oninput="app.updateUrlPreview('p-img')">
                        <input id="p-img-file" type="file" accept="image/*" style="display:none;" onchange="app.previewImage(this, 'p-img-preview')">
                        <img id="p-img-preview" class="file-preview">
                        <input type="hidden" id="p-img-final">
                    </div>

                    <div class="form-group">
                        <label>Wooden Type</label>
                        <input id="p-wood" type="text" placeholder="e.g. Teak, Jack">
                        <div class="suggestion-chips">
                            <span class="chip" onclick="app.setInput('p-wood', 'Teak')">Teak</span>
                            <span class="chip" onclick="app.setInput('p-wood', 'Mahogany')">Mahogany</span>
                            <span class="chip" onclick="app.setInput('p-wood', 'Jack')">Jack</span>
                            <span class="chip" onclick="app.setInput('p-wood', 'Mara')">Mara</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Finishes (Select Multiple)</label>
                        <input id="p-colors" type="text" placeholder="e.g. Black, Brown">
                        <div class="suggestion-chips">
                            <span class="chip" onclick="app.appendInput('p-colors', 'Natural')">Natural</span>
                            <span class="chip" onclick="app.appendInput('p-colors', 'Dark')">Dark</span>
                            <span class="chip" onclick="app.appendInput('p-colors', 'Black')">Black</span>
                            <span class="chip" onclick="app.appendInput('p-colors', 'White')">White</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Sizes (Select Multiple)</label>
                        <input id="p-size" type="text" placeholder="e.g. King, 6x4 ft">
                        <div class="suggestion-chips">
                            <span class="chip" onclick="app.appendInput('p-size', 'Standard')">Standard</span>
                            <span class="chip" onclick="app.appendInput('p-size', 'King')">King</span>
                            <span class="chip" onclick="app.appendInput('p-size', 'Queen')">Queen</span>
                            <span class="chip" onclick="app.appendInput('p-size', '6x4')">6x4</span>
                        </div>
                    </div>

                    <div class="form-group"><label>Badge (Optional)</label><input id="p-badge" type="text" placeholder="e.g. Sale, New"></div>
                </div>
                
                <div class="form-group" style="margin-bottom: 30px;">
                    <label>Description</label>
                    <textarea id="p-desc" rows="4" placeholder="Describe the item..."></textarea>
                </div>
                
                <button id="save-product-btn" class="btn btn-primary" onclick="app.saveProduct()"><i class="fa-solid fa-plus"></i> Add Product</button>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">Inventory Items</span></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Image</th><th>Name</th><th>Details</th><th>Price</th><th>Actions</th></tr></thead>
                        <tbody id="product-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        const supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

        // --- ADMIN APP LOGIC ---
        const app = {
            shops: [],
            products: [],
            currentShopId: null,
            editingProductId: null,

            init: async function() {
                await this.loadData();
                this.renderShopTable();
            },

            loadData: async function() {
                if(supabase) {
                    let { data: s } = await supabase.from('shops').select('*');
                    let { data: p } = await supabase.from('products').select('*');
                    if(s) this.shops = s;
                    if(p) this.products = p;
                } else {
                    this.shops = JSON.parse(localStorage.getItem('leepola_shops')) || [];
                    this.products = JSON.parse(localStorage.getItem('leepola_products')) || [];
                }
            },

            saveData: function() {
                try {
                    localStorage.setItem('leepola_shops', JSON.stringify(this.shops));
                    localStorage.setItem('leepola_products', JSON.stringify(this.products));
                } catch (e) {
                    alert("Storage Error: Image file likely too large. Please upload a smaller image.");
                }
            },

            setInput: function(id, val) {
                document.getElementById(id).value = val;
            },

            appendInput: function(id, val) {
                const el = document.getElementById(id);
                if(el.value === "") {
                    el.value = val;
                } else if(!el.value.includes(val)) {
                    el.value += ", " + val;
                }
            },

            showShopList: function() {
                document.getElementById('view-shops').classList.add('active');
                document.getElementById('view-single').classList.remove('active');
                document.getElementById('menu-shops').classList.add('active');
                document.getElementById('menu-current').classList.remove('active');
                document.getElementById('menu-current').style.display = 'none';
                this.currentShopId = null;
                this.cancelEdit(); 
            },

            showShopDashboard: function(shopId) {
                if(shopId) this.currentShopId = shopId;
                const shop = this.shops.find(s => s.id === this.currentShopId);
                
                if(!shop) return this.showShopList();

                document.getElementById('dash-shop-name').innerText = shop.name;
                document.getElementById('dash-shop-loc').innerText = "ðŸ“ " + shop.location;
                
                document.getElementById('view-shops').classList.remove('active');
                document.getElementById('view-single').classList.add('active');
                
                document.getElementById('menu-shops').classList.remove('active');
                const currentMenu = document.getElementById('menu-current');
                currentMenu.style.display = 'flex';
                document.getElementById('nav-shop-name').innerText = shop.name;
                currentMenu.classList.add('active');

                this.renderProductTable();
                this.cancelEdit();
            },

            switchImgInput: function(prefix, type) {
                const urlInput = document.getElementById(prefix + '-url');
                const fileInput = document.getElementById(prefix + '-file');
                const finalInput = document.getElementById(prefix + '-final');
                const tabs = event.target.parentElement.children;
                
                if(type === 'url') {
                    urlInput.style.display = 'block';
                    fileInput.style.display = 'none';
                    tabs[0].classList.add('active');
                    tabs[1].classList.remove('active');
                    fileInput.value = ''; 
                    finalInput.value = ''; 
                } else {
                    urlInput.style.display = 'none';
                    fileInput.style.display = 'block';
                    tabs[0].classList.remove('active');
                    tabs[1].classList.add('active');
                    urlInput.value = '';
                }
            },

            previewImage: function(input, previewId) {
                const file = input.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById(previewId);
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        const hiddenInputId = previewId.replace('-preview', '-final');
                        document.getElementById(hiddenInputId).value = e.target.result; 
                    }
                    reader.readAsDataURL(file);
                }
            },

            updateUrlPreview: function(prefix) {
                const url = document.getElementById(prefix + '-url').value;
                const preview = document.getElementById(prefix + '-preview');
                if(url) {
                    preview.src = url;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            },

            getFinalImage: function(prefix) {
                const fileData = document.getElementById(prefix + '-final').value;
                if(fileData) return fileData;
                const urlData = document.getElementById(prefix + '-url').value;
                return urlData; 
            },

            addShop: async function() {
                const name = document.getElementById('s-name').value;
                const loc = document.getElementById('s-loc').value;
                const tel = document.getElementById('s-tel').value;
                const logo = this.getFinalImage('s-logo') || 'https://via.placeholder.com/150';

                if(!name || !loc) return alert("Name and Location are required!");

                if(supabase) {
                    const { data, error } = await supabase.from('shops').insert([{ name: name, location: loc, tel: tel, logo: logo }]).select();
                    if(error) return alert("Error: " + error.message);
                    this.shops.push(data[0]);
                } else {
                    const newId = this.shops.length > 0 ? Math.max(...this.shops.map(s => s.id)) + 1 : 1;
                    this.shops.push({ id: newId, name, location: loc, tel, logo });
                    this.saveData();
                }

                this.renderShopTable();
                document.getElementById('s-name').value = '';
                document.getElementById('s-loc').value = '';
                document.getElementById('s-tel').value = '';
                document.getElementById('s-logo-url').value = '';
                document.getElementById('s-logo-final').value = '';
                document.getElementById('s-logo-preview').style.display = 'none';
                alert("Shop Created Successfully!");
            },

            deleteShop: async function(id) {
                if(confirm("âš  Delete this shop? All its products will be deleted too!")) {
                    if(supabase) {
                        await supabase.from('shops').delete().eq('id', id);
                        await supabase.from('products').delete().eq('shop_id', id);
                        this.shops = this.shops.filter(s => s.id !== id);
                        this.products = this.products.filter(p => p.shopId !== id);
                    } else {
                        this.shops = this.shops.filter(s => s.id !== id);
                        this.products = this.products.filter(p => p.shopId !== id);
                        this.saveData();
                    }
                    this.renderShopTable();
                }
            },

            renderShopTable: function() {
                const tbody = document.getElementById('shop-table');
                if(this.shops.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px;">No shops found. Add one above!</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = this.shops.map(s => `
                    <tr>
                        <td><img src="${s.logo}" class="table-img"></td>
                        <td><strong>${s.name}</strong></td>
                        <td>${s.location}</td>
                        <td>${s.tel}</td>
                        <td>
                            <div class="action-group">
                                <button class="action-btn btn-manage" onclick="app.showShopDashboard(${s.id})"><i class="fa-solid fa-gear"></i> Manage</button>
                                <button class="action-btn btn-delete" onclick="app.deleteShop(${s.id})"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            },

            saveProduct: async function() {
                if(!this.currentShopId) return alert("Error: No shop selected.");

                const name = document.getElementById('p-name').value;
                const price = document.getElementById('p-price').value;
                const cat = document.getElementById('p-cat').value;
                const badge = document.getElementById('p-badge').value;
                const desc = document.getElementById('p-desc').value;
                const woodType = document.getElementById('p-wood').value;
                const colorsRaw = document.getElementById('p-colors').value;
                const colors = colorsRaw ? colorsRaw.split(',').map(s => s.trim()) : ['Standard'];
                const sizesRaw = document.getElementById('p-size').value;
                const sizes = sizesRaw ? sizesRaw.split(',').map(s => s.trim()) : ['Standard'];
                
                let img = this.getFinalImage('p-img');
                
                if(!name || !price) return alert("Product Name and Price are required!");

                if (this.editingProductId) {
                    if(supabase) {
                        const { data, error } = await supabase.from('products').update({ name, price: parseFloat(price), category: cat, badge, description: desc, image: img || 'https://via.placeholder.com/600x400', colors, sizes, wood_type: woodType }).eq('id', this.editingProductId).select();
                        if(error) return alert("Error: " + error.message);
                         // Update local array
                         const idx = this.products.findIndex(p => p.id === this.editingProductId);
                         if (idx > -1) this.products[idx] = data[0];
                    } else {
                        const productIndex = this.products.findIndex(p => p.id === this.editingProductId);
                        if (productIndex > -1) {
                            if (!img) img = this.products[productIndex].image;
                            this.products[productIndex] = { ...this.products[productIndex], name, price: parseFloat(price), category: cat, badge, desc, image: img, sizes: sizes, colors: colors, woodType: woodType };
                        }
                    }
                    alert("Product Updated Successfully!");
                } else {
                    if (!img) img = 'https://via.placeholder.com/600x400';
                    
                    if(supabase) {
                        const { data, error } = await supabase.from('products').insert([{ shop_id: this.currentShopId, name, price: parseFloat(price), category: cat, badge, description: desc, image: img, colors, sizes, wood_type: woodType }]).select();
                        if(error) return alert("Error: " + error.message);
                        this.products.push(data[0]);
                    } else {
                        const newId = this.products.length > 0 ? Math.max(...this.products.map(p => p.id)) + 1 : 101;
                        this.products.push({ id: newId, shopId: this.currentShopId, name, price: parseFloat(price), category: cat, image: img, badge, desc: desc || "No description provided.", sizes: sizes, colors: colors, woodType: woodType });
                        this.saveData();
                    }
                    alert("Product Added to Inventory!");
                }
                this.renderProductTable();
                this.cancelEdit(); 
            },

            editProduct: function(id) {
                const p = this.products.find(prod => prod.id === id);
                if (!p) return;

                document.getElementById('p-name').value = p.name;
                document.getElementById('p-price').value = p.price;
                document.getElementById('p-cat').value = p.category;
                document.getElementById('p-badge').value = p.badge;
                document.getElementById('p-desc').value = p.desc || p.description; // Handle both key names
                document.getElementById('p-wood').value = p.woodType || p.wood_type || '';
                
                document.getElementById('p-colors').value = p.colors ? (Array.isArray(p.colors) ? p.colors.join(', ') : p.colors) : '';
                document.getElementById('p-size').value = p.sizes ? (Array.isArray(p.sizes) ? p.sizes.join(', ') : p.sizes) : '';

                const preview = document.getElementById('p-img-preview');
                preview.src = p.image;
                preview.style.display = 'block';
                document.getElementById('p-img-url').value = '';
                document.getElementById('p-img-file').value = '';
                document.getElementById('p-img-final').value = ''; 

                this.editingProductId = id;
                
                document.getElementById('form-title').innerText = "Edit Product: " + p.name;
                document.getElementById('form-title').style.color = "var(--blue)";
                const saveBtn = document.getElementById('save-product-btn');
                saveBtn.innerHTML = "<i class='fa-solid fa-floppy-disk'></i> Save Changes";
                saveBtn.className = "btn btn-update";
                document.getElementById('cancel-edit-btn').style.display = 'block';

                document.getElementById('product-form-card').scrollIntoView({behavior: 'smooth'});
            },

            cancelEdit: function() {
                document.getElementById('p-name').value = '';
                document.getElementById('p-price').value = '';
                document.getElementById('p-badge').value = '';
                document.getElementById('p-desc').value = '';
                document.getElementById('p-wood').value = '';
                document.getElementById('p-colors').value = '';
                document.getElementById('p-size').value = '';
                document.getElementById('p-img-url').value = '';
                document.getElementById('p-img-final').value = '';
                document.getElementById('p-img-file').value = '';
                document.getElementById('p-img-preview').style.display = 'none';

                this.editingProductId = null;
                document.getElementById('form-title').innerText = "Add Product";
                document.getElementById('form-title').style.color = "var(--primary)";
                const saveBtn = document.getElementById('save-product-btn');
                saveBtn.innerHTML = "<i class='fa-solid fa-plus'></i> Add Product";
                saveBtn.className = "btn btn-primary";
                document.getElementById('cancel-edit-btn').style.display = 'none';
            },

            deleteProduct: async function(id) {
                if(confirm("Delete this product?")) {
                    if(supabase) {
                        await supabase.from('products').delete().eq('id', id);
                        this.products = this.products.filter(p => p.id !== id);
                    } else {
                        this.products = this.products.filter(p => p.id !== id);
                        this.saveData();
                    }
                    this.renderProductTable();
                    if(this.editingProductId === id) this.cancelEdit(); 
                }
            },

            renderProductTable: function() {
                const tbody = document.getElementById('product-table');
                // Filter products for ONLY current shop. Note: Supabase uses shop_id, Local uses shopId
                const shopProducts = this.products.filter(p => (p.shopId === this.currentShopId || p.shop_id === this.currentShopId));

                if(shopProducts.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">Inventory is empty. Add items above.</td></tr>`;
                    return;
                }

                tbody.innerHTML = shopProducts.map(p => `
                    <tr>
                        <td><img src="${p.image}" class="table-img"></td>
                        <td>
                            <strong>${p.name}</strong><br>
                            ${p.badge ? `<span style="font-size:0.7rem; background:#2D1B15; color:#C5A059; padding:2px 6px; border-radius:4px;">${p.badge}</span>` : ''}
                        </td>
                        <td style="font-size:0.85rem; color:#666;">
                            <b>${p.woodType || p.wood_type || 'Wood'}</b> - ${p.category}<br>
                            Size: ${Array.isArray(p.sizes) ? p.sizes.join(', ') : p.sizes} <br>
                            Finish: ${Array.isArray(p.colors) ? p.colors.join(', ') : p.colors}
                        </td>
                        <td style="color:#5D4037; font-weight:bold;">Rs. ${p.price.toLocaleString()}</td>
                        <td>
                            <div class="action-group">
                                <button class="action-btn btn-edit" onclick="app.editProduct(${p.id})"><i class="fa-solid fa-pen"></i></button>
                                <button class="action-btn btn-delete" onclick="app.deleteProduct(${p.id})"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            },

            resetData: function() {
                if(confirm("DANGER: This will wipe all changes and restore default data. Continue?")) {
                    localStorage.clear();
                    location.href = "index.html"; 
                }
            }
        };

        app.init();
    </script>
</body>
</html>